# AI Agent 工作约束与协作指南（详细版）

> **版本**: v2.0  
> **更新日期**: 2026-02-08  
> **适用范围**: 所有 AI Assistant 协作场景  
> **核心规则**：见 [RULES.md](RULES.md)（精简版，<100行）

**使用说明**：

- **日常使用**：Agent 应优先遵守 `RULES.md` 中的核心规则
- **详细参考**：本文档提供完整的约束说明、示例和最佳实践
- **按需查阅**：需要详细说明时查阅本文档

---

## 目录

- [安全约束详细说明](#安全约束详细说明)
- [工作流约束详细说明](#工作流约束详细说明)
- [代码质量约束详细说明](#代码质量约束详细说明)
- [协作与沟通最佳实践](#协作与沟通最佳实践)
- [决策与规划指南](#决策与规划指南)
- [文档管理指南](#文档管理指南)
- [检查清单详细版](#检查清单详细版)
- [例外处理流程](#例外处理流程)
- [参考资源](#参考资源)

---

**注意**：核心规则已移至 [RULES.md](RULES.md)，本文档仅提供详细说明、示例和最佳实践。

---

## 安全约束详细说明

### P0-1: 禁止读取敏感文件

**规则**：

- ✗ **永不读取**任何 `.env*` 文件（含 `.env.local`、`.env.production` 等）
- ✗ 拒绝读取含私钥/API 密钥的文件
- ✓ 基于**文件名黑名单**自动拒绝，不依赖用户提醒

**敏感文件模式**：

```
.env*
*.key
*.pem
*.p12
*secret*
*private*
*credential*
```

**处理方式**：

- 自动拒绝读取请求
- 提示："出于安全考虑，无法读取敏感文件。请使用 `.env.example` 作为参考。"

### P0-2: 不修改安全政策

**规则**：

- ✗ 不删除或修改本约束文件（除非用户明确要求）
- ✓ 每个 commit 前检查是否被意外修改
- ✓ 安全政策变更需用户明确批准

### P0-3: 禁止暴露敏感信息

**规则**：

- ✗ 不在代码、文档、日志、截图中暴露私钥、API Key、RPC 密钥
- ✗ 不提交 `.env` 到 Git
- ✓ 使用 `.env.example` 作为公开模板（占位符替代真实值）
- ✓ 与 AI 交互时只讨论 `.env.example`，用占位符描述

**敏感信息类型**：

- `PRIVATE_KEY`、`MNEMONIC`
- `API_KEY`、`API_SECRET`
- `RPC_URL`（含密钥的）
- `.env*` 文件内容

**泄露处理流程**：

1. 立即停用该密钥（转移资金 / 轮换 API Key）
2. 从 Git 历史移除（`git-filter-branch` 或 BFG）
3. 通知团队并更新安全记录

---

## 工作流约束详细说明

### P1-1: 分支管理

**规则**：

- ✓ **每次修改文件前**，检查主仓和子模块是否在 `main` 分支
- ✓ 若在 main：`git checkout -b feature/xxx` 切换到新分支
- ✗ 不得在 main 分支上直接修改

**检查步骤**：

```bash
# 主仓检查
git branch --show-current  # 确认不在 main

# 子模块检查（如 frontend/）
cd frontend && git branch --show-current
```

**分支命名规范**：

- `feature/功能名`（如 `feature/add-metrics-api`）
- `fix/问题描述`（如 `fix/typecheck-errors`）
- `docs/文档类型`（如 `docs/update-readme`）

### P1-2: Git 提交规范

**规则**：

- ✓ commit 消息格式：`[类型] 简短描述` 或 `Phase X: 操作描述`
- ✓ 一个 commit 一个完整功能
- ✓ commit 完成后立即 `git push`（除非网络不可用或用户要求暂不推送）
- ✗ 不用 "WIP"、"temp"、"fix" 等模糊信息

**提交类型**：

- `feat`: 新功能
- `fix`: 修复问题
- `docs`: 文档更新
- `refactor`: 重构
- `test`: 测试相关
- `chore`: 构建/工具相关

**示例**：

```
✅ feat: Add metrics API endpoint
✅ fix: Resolve typecheck errors in policy.ts
✅ docs: Update README with deployment guide
❌ WIP: some changes
❌ fix
```

### P1-3: 任务追踪

**规则**：

- ✓ 多步骤工作（3+ 步）使用 todo 工具，显式标记状态
- ✗ 不能同时标记多个 TODO 为 `in-progress`
- ✓ 任务完成后立即更新状态

**Todo 状态**：

- `pending`: 未开始
- `in-progress`: 进行中（同时只能有一个）
- `completed`: 已完成
- `cancelled`: 已取消

### P1-4: 工作日志管理

**规则**：

- ✓ 每个 Phase 完成后立即更新 `AGENT_WORKLOG.md`（背景、步骤、文件变更、验证）
- ✓ 每次 commit 有对应日志条目
- ✓ `AGENT_WORKLOG.md` 达 1000 行时，自动精简到 500 行内

**日志精简规则**：

- **保留**：Phase 摘要表、当前状态、运行命令、关键文件、附录
- **精简**：各 Phase 描述压缩为 2–4 行要点

---

## 代码质量约束详细说明

### P0-4: 代码提交前必须验证

**规则**：

- ✗ 不提交未通过 `pnpm typecheck` 的代码（0 errors）
- ✗ 不提交未通过演示脚本的代码（`pnpm demo:pay`、`pnpm demo:reject`）
- ✓ 修改代码后必须重新验证

**验证步骤**：

```bash
# 1. 类型检查
pnpm typecheck

# 2. 运行演示脚本
pnpm demo:pay
pnpm demo:reject

# 3. 确认通过后再提交
```

### P1-5: TypeScript 严格模式

**规则**：

- ✓ 所有 `.ts` 文件通过 `pnpm typecheck`（0 errors）
- ✗ 不使用 `any`（除非别无选择并注释说明）
- ✓ 使用明确的类型定义

**`any` 使用例外**：

```typescript
// ❌ 避免
const data: any = fetchData();

// ✅ 允许（需注释说明原因）
// 第三方库类型定义不完整，暂时使用 any
const data: any = thirdPartyLib.getData();
```

### P1-6: 不破坏现有功能

**规则**：

- ✓ 重构时保证已通过测试仍通过
- ✗ 不能为简化某部分而删除其他工作功能
- ✓ 修改前确认影响范围

**验证方法**：

- 运行所有演示脚本
- 检查相关测试用例
- 确认 API 接口兼容性

---

## 协作与沟通最佳实践

### P2-1: 沟通风格

**规则**：

- ✓ 复杂信息**分段显示**，不要一次性长篇幅回复
- ✓ **重要信息用加粗和列表突出**
- ✓ 避免重复解释同一个概念
- ✓ 目标：用户一眼就能看懂，不需要重复阅读

**回复长度建议**：

- 单个文件修改：1-2 段
- 多文件改动：3-5 段（分段展示）
- 重大重构：每步单独回复

### P2-2: 进度反馈

**规则**：

- ✓ 关键任务完成后用 1-2 句话简短总结，然后问"**可以吗？**"
- ✓ 不要一口气做完所有事再汇报
- ✓ 给用户改正机会（可能中途要调整方向）

**工作节奏**：

| 任务规模         | 反馈频率   | 沟通风格                   |
| ---------------- | ---------- | -------------------------- |
| 单个文件修改     | 完成即汇报 | "已完成 X，接下来..."      |
| 多文件改动（3+） | 完成前确认 | "计划做 A/B/C，你同意吗？" |
| 重大重构         | 每步都问   | "第 1 步做好了，继续？"    |
| 调查/研究        | 做完才汇报 | "研究结果：..."            |

### P2-3: 询问式沟通

**规则**：

- ✓ 用"你认为应该...还是...？"的方式询问
- ✗ 不用"我觉得应该..."的断言方式
- ✓ 提供 3-5 个选项供选择

**示例对比**：

❌ **不好的方式**：

> 我觉得文档应该分为 guides/reference/internal，我已经全部改好了并 push 到 Git。

✅ **好的方式**：

> 我觉得文档有点混乱。建议有三种整理方式：
>
> 1. 按文档类型（指南/参考/内部）分目录
> 2. 按角色分目录（A/B/C/D）
> 3. 保持根目录但用前缀区分（guide-, ref-, internal-)
>
> 你倾向哪个？

---

## 决策与规划指南

### P1-7: 重大决策需确认

**重大决策定义**：

- 架构变更（如引入新框架、改变项目结构）
- 大重构（影响 5+ 文件）
- 删除代码或功能
- 改变职责分工
- 新增核心功能

**决策流程**：

1. **列出选项**：提供 3-5 个可行方案
2. **说明利弊**：每个选项的优缺点
3. **等待确认**：用户选择后再执行
4. **文档化**：决策记录在适当文件中

### P2-4: 避免过度规划（Gold Plating）

**规则**：

- ✓ **MVP 项目就是 MVP**，不要为"可能需要"的功能提前准备
- ✓ 如果用户没有说"需要"，就**不要写**
- ✓ **问清楚优先级**：是"必需"还是"锦上添花"？

**判断标准**：

- 用户明确要求 → 必需
- 用户未提及但"可能有用" → 询问
- 用户未提及且"未来可能" → 不做

**示例**：

❌ **过度规划**：

> 我为 4 个场景都写了完整指南，包括未来可能用到的场景。

✅ **MVP 优先**：

> 哪 1-2 个场景最重要？先做那个。

### P2-5: 时间估计

**规则**：

- ✓ 对于时间估计，**明确说**"这是我的估计，实际可能 X-Y 小时"
- ✗ 不要保证时间线
- ✓ 提供估计范围而非精确时间

**示例**：

```
✅ "Web UI 推荐用 React + Tailwind，我没有实际验证时间，可能需要 2-4 小时"
❌ "Web UI 2 小时完成"
```

---

## 文档管理指南

### P1-8: 文档控制

**规则**：

- ✓ 创建新文档前询问是否真正需要
- ✓ 文档简洁、单一目的、易维护
- ✗ 不创建冗余或一次性文档

**文档判断标准**：

- 目标受众明确 → 需要
- 信息可复用 → 需要
- 一次性说明 → 不需要（在代码注释中说明）
- 已有类似文档 → 不需要（更新现有文档）

### P2-6: 写精炼文档

**规则**：

- ✓ **删除冗余重复的内容**（不要为了显得"全"而堆砌）
- ✓ 每个文档的**目标受众**是谁？写给他们就够了
- ✓ 避免"参考指南"写得像"强制要求"（要加声明"仅供参考"）
- ✓ 用表格和列表，少用长段落
- ✓ 黄金比例：20% 是必需信息，80% 是冗余，要砍掉那 80%

**文档结构建议**：

1. **目标受众**（1 句话）
2. **核心内容**（表格/列表）
3. **示例**（1-2 个）
4. **参考链接**（如有）

### P1-9: 设计决策文档化

**规则**：

- ✓ 非平凡技术决策记录在适当文件中
- ✗ 不能只在对话中说明
- ✓ 决策记录包含：背景、选项、选择理由、影响范围

**文档位置**：

- 架构决策 → `docs/reference/ARCHITECTURE.md`
- 技术选型 → `docs/reference/TECH_STACK.md`
- 设计模式 → 代码注释或设计文档

### P1-10: 环境变量范式

**规则**：

- ✓ 所有配置有 `.env.example` 条目
- ✗ 不引入未在模板中记录的新环境变量
- ✓ 修改 `.env.example` 后更新相关文档

**环境变量格式**：

```bash
# 分组注释
# 变量说明（可选：默认值）
VARIABLE_NAME=default_value_or_placeholder
```

---

## 检查清单详细版

### 工作开始前检查

**重大决策判断**：

- [ ] 这是架构变更吗？（引入新框架、改变项目结构）
- [ ] 这是大重构吗？（影响 5+ 文件）
- [ ] 这是删除代码或功能吗？
- [ ] 这是新增核心功能吗？
- **如果以上任一为是** → 列出 3-5 个选项，等待用户确认

**分支检查**：

- [ ] 主仓当前分支：`git branch --show-current`
- [ ] 若在 main：`git checkout -b feature/xxx`
- [ ] 子模块检查（如有）：`cd frontend && git branch --show-current`

**文档冗余检查**：

- [ ] 目标受众明确吗？
- [ ] 信息可复用吗？
- [ ] 是否已有类似文档？（更新而非新建）

### 代码修改后验证

**类型检查**：

```bash
pnpm typecheck  # 必须 0 errors
```

**功能验证**：

```bash
pnpm demo:pay      # 必须正常
pnpm demo:reject   # 必须正常
```

**提交前检查**：

- [ ] 未新增/修改 `.env*` 文件
- [ ] commit message 格式正确（`[类型] 描述` 或 `Phase X: 操作`）
- [ ] 已 push 到远程（`git push`）

### 任务完成后检查

**日志更新**：

- [ ] AGENT_WORKLOG 已更新（如适用）
- [ ] 包含：背景、步骤、文件变更、验证结果

**文档化**：

- [ ] 重要决定已记录在适当文件
- [ ] 设计决策包含：背景、选项、选择理由、影响范围

**沟通确认**：

- [ ] 关键任务已询问用户"可以吗？"
- [ ] 用户反馈已及时处理

---

## 例外处理流程

### 可请求修改约束的情况

仅在以下情况可请求修改约束：

1. 用户明确要求
2. 约束导致严重阻碍且无替代方案
3. 约束含安全漏洞

### 修改流程

1. **Agent 提议**：说明原因和替代方案
2. **用户批准**：获得明确同意
3. **更新约束**：修改本文件
4. **Commit 说明**：在 commit message 中说明原因

---

## 参考资源

### 项目特定文档

待添加

### 外部资源

- [Cursor Rules Best Practices](https://cursor.com/docs/context/rules)
- [Conventional Commits](https://www.conventionalcommits.org/)
- [Git Flow](https://www.atlassian.com/git/tutorials/comparing-workflows/gitflow-workflow)

---

## 版本历史

- **v2.0**（2026-02-08）：整合 `.clinerules` 和 `HUMAN_CONSTRAINTS_FOR_AGENT.md`，采用优先级分类，优化结构，重命名为通用格式
- **v1.0**（2026-01-30）：初始版本（`HUMAN_CONSTRAINTS_FOR_AGENT.md`）

---

**使用说明**：

- **核心规则**：见 [RULES.md](RULES.md)（精简版，Agent 必须遵守）
- **详细参考**：本文档提供补充说明、示例和最佳实践
- **按需查阅**：需要详细说明时查阅本文档
